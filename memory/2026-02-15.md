# 2026-02-15

## Review App Fix
- Fixed approval workflow bug in `canasta-rules/review_app.py`
- Issue: JavaScript fetch wasn't completing cleanly, causing slow refreshes
- Solution: Changed from `fetch()` + `location.reload()` to proper form POST with 303 redirect
- Restarted the review app (PID 37026 on port 8765)

## Cron Job Delivery Fix
- **Problem:** Jobs were running but not sending completion messages to #chloe-logs
- **Root cause:** All jobs had `delivery: {mode: "none"}` — isolated sessions can't send messages via payload text alone
- **Solution:** Updated all 10 jobs with `delivery: {mode: "announce", channel: "slack", to: "C0AELHCGW4F"}`
- **Learning:** MUST set delivery config explicitly; putting "send a message to channel X" in payload text doesn't work for isolated sessions

## BSR Checker System (NEW)
Created system to identify wholesale items worth shipping to FBA based on sales rank.

**Keepa API Key:** Added to `~/amazon-data/.env` as `KEEPA_API_KEY`
- Token rate: 5 tokens/minute, renews Dec 1, 2026
- Cost: ~1 token per ASIN

**Script:** `~/amazon-data/collectors/bsr_checker.py`
- Fetches BSR from Keepa for all Overstock ASINs
- Updates column O (BSR) — only writes if BSR < 400,000, otherwise leaves blank
- Checks P1 for "Ship" indicator (Ramon's formula)
- If P1 = "Ship" → alerts to #chloebot
- Added 65-second wait between batches to avoid rate limits

**Cron Job:** `446cdd06-703e-40a2-a223-2b51b397a8dc`
- Schedule: Sunday & Wednesday at 9 PM EST (`0 21 * * 0,3`)
- Logs to #chloe-logs, ship alerts to #chloebot

**First Run Results:**
- 341 unique ASINs across 480 rows
- 300 with BSR data (hit rate limit on 4th batch before fix)
- 131 items with BSR < 400,000
- P1 showed "Ship" — alert triggered

## Overstock Sheet Structure
- Column O: BSR (only populated if < 400,000)
- Column P1: Ship indicator formula (Ramon's) — shows "Ship" when ready
- Column P2: Also has a formula — DO NOT OVERWRITE P1/P2

## Cron Job Total: 15 jobs now
All with proper delivery to #chloe-logs:
1. Daily Amazon Collection (6 AM)
2. Daily PPC Collection (6:30 AM)
3. Daily Rank Collection (7 AM)
4. Daily Strategy Report (7 AM)
5. Rank Collection Retry (10 AM, 1/4/7/10 PM)
6. Product Master Sync (5:30 AM)
7. Wholesale Pricing (6 AM/6 PM) — includes eBay sync
8. Facebook Scraper (10:30 PM)
9. Weekly SQP (Mon 6 AM)
10. SQP Retry (Mon-Wed, multiple times)
11. **BSR Check (Sun/Wed 9 PM)** — NEW
12. **Listing Monitor Monday (Mon 8 AM)** — weekly summary
13. **Listing Monitor Tue-Fri (8 AM)** — changes only
14. **GSC Weekly Report (Mon 9 AM)** — passive SEO data

## Late Night Cron Investigation (11 PM)

**Problem:** 9 PM BSR cron job didn't fire, despite being enabled with correct config.

**Investigation findings:**
- Gateway logs show multiple restarts between 9:19 PM and 11:05 PM EST
- Each restart resets the cron scheduler's `nextWakeAtMs`
- By 11:05 PM, the scheduler had skipped past 9 PM and calculated next wake as 5:30 AM Feb 17
- Run history for the job was empty — it never fired

**Root cause:** Gateway restarts during the scheduled window caused the cron to miss its trigger.

**Resolution:** Manually triggered the job with `openclaw cron run <jobId> --force`
- Created isolated session `agent:main:cron:446cdd06-703e-40a2-a223-2b51b397a8dc`
- BSR checker now running

**Key learnings:**
- `cron action=run` without `--force` returns "not-due" — need CLI with `--force` flag
- Gateway restarts can cause cron jobs to be skipped silently
- launchd fallback jobs are good insurance for critical tasks
